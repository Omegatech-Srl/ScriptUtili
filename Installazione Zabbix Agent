#
# SCRIPT PRONTO ALL'USO
#

# Installa Zabbix agent su Windows
# Testato su Windows Server 2012, 2012R2, 2016, 2019
# Versione 2.02
# Creato da Matteo Giustini
# Ultimo update 14/08/2024


$version702ssl = "https://cdn.zabbix.com/zabbix/binaries/stable/7.0/7.0.2/zabbix_agent-7.0.2-windows-amd64-openssl.zip"

# Prende server hostname
$serverHostname = Invoke-Command -ScriptBlock {hostname}

# Fornisce IP pubblico zabbix server
$ServerIP = "145.14.161.84"

# Crea Zabbix DIR
$zabbixDir = "c:\zabbix"
if (-not (Test-Path $zabbixDir)) {
    mkdir $zabbixDir
}

# Scarica versione dalla variabile
$zabbixZip = "$zabbixDir\zabbix.zip"
Invoke-WebRequest -Uri $version702ssl -OutFile $zabbixZip

# Verifica se il download Ã¨ stato completato
if (-not (Test-Path $zabbixZip)) {
    Write-Error "Download failed. Exiting script."
    exit 1
}

Add-Type -AssemblyName System.IO.Compression.FileSystem

function Unzip {
    param([string]$zipfile, [string]$outpath)
    try {
        [System.IO.Compression.ZipFile]::ExtractToDirectory($zipfile, $outpath)
    } catch {
        Write-Host "Failed to unzip `${zipfile}: $($_.Exception.Message)`"
        exit 1
    }
}

# Unzip
Unzip $zabbixZip $zabbixDir

# Verifica se i file sono stati estratti correttamente
$agentExePath = "$zabbixDir\bin\zabbix_agentd.exe"
$agentConfPath = "$zabbixDir\conf\zabbix_agentd.conf"

if (-not (Test-Path $agentExePath) -or -not (Test-Path $agentConfPath)) {
    Write-Error "Unzipped files not found. Exiting script."
    exit 1
}

# Sposta files
Move-Item $agentExePath -Destination $zabbixDir

# Sposta conf
Move-Item $agentConfPath -Destination $zabbixDir

# Imposta IP pubblico server zabbix in conf
(Get-Content -Path "$zabbixDir\zabbix_agentd.conf") | ForEach-Object {$_ -Replace '127.0.0.1', "$ServerIP"} | Set-Content -Path "$zabbixDir\zabbix_agentd.conf"

# Imposta hostname in conf
(Get-Content -Path "$zabbixDir\zabbix_agentd.conf") | ForEach-Object {$_ -Replace 'Windows host', "$serverHostname"} | Set-Content -Path "$zabbixDir\zabbix_agentd.conf"

# Tenta installazione agent
& "$zabbixDir\zabbix_agentd.exe" --config "$zabbixDir\zabbix_agentd.conf" --install

# Tenta start agent
& "$zabbixDir\zabbix_agentd.exe" --start

# Crea regola su fw windows
New-NetFirewallRule -DisplayName "Allow Zabbix communication" -Direction Inbound -Program "$zabbixDir\zabbix_agentd.exe" -RemoteAddress LocalSubnet -Action Allow
