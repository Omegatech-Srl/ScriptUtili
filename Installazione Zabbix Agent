#
# SCRIPT PRONTO ALL'USO
#

# Installa Zabbix agent su Windows
# Testato su Windows Server 2012, 2012R2, 2016, 2019
# Versione 2.02
# Creato da Matteo Giustini
# Ultimo update 14/08/2024


# Variables
$zabbixAgentUrl = "https://cdn.zabbix.com/zabbix/binaries/stable/7.0/7.0.2/zabbix_agent-7.0.2-windows-amd64-openssl.msi"
$zabbixAgentMsi = "C:\zabbix_agent.msi"
$zabbixServerIp = "145.14.161.84"
$hostname = (hostname)

# Download the Zabbix Agent MSI
Write-Host "Downloading Zabbix Agent..."
Invoke-WebRequest -Uri $zabbixAgentUrl -OutFile $zabbixAgentMsi

# Install the Zabbix Agent
Write-Host "Installing Zabbix Agent..."
Start-Process msiexec.exe -ArgumentList "/i `"$zabbixAgentMsi`" /quiet /norestart /L*v install.log" -Wait

# Configure Zabbix Agent to point to the Zabbix Server
Write-Host "Configuring Zabbix Agent..."
$zabbixConfigPath = "C:\Program Files\Zabbix Agent\zabbix_agentd.conf"
(Get-Content -Path $zabbixConfigPath) -replace "Server=127.0.0.1", "Server=$zabbixServerIp" | Set-Content -Path $zabbixConfigPath
(Get-Content -Path $zabbixConfigPath) -replace "Hostname=Windows host", "Hostname=$hostname" | Set-Content -Path $zabbixConfigPath

# Start the Zabbix Agent service
Write-Host "Starting Zabbix Agent service..."
Start-Service -Name "Zabbix Agent"

# Confirm that the service is running
$serviceStatus = Get-Service -Name "Zabbix Agent"
if ($serviceStatus.Status -eq 'Running') {
    Write-Host "Zabbix Agent service is running."
} else {
    Write-Error "Failed to start Zabbix Agent service."
}
