#
# SCRIPT PRONTO ALL'USO
#

# Installa Zabbix agent su Windows
# Testato su Windows Server 2012, 2012R2, 2016, 2019
# Versione 2.02
# Creato da Matteo Giustini
# Ultimo update 14/08/2024



$version702ssl = " https://cdn.zabbix.com/zabbix/binaries/stable/7.0/7.0.2/zabbix_agent-7.0.2-windows-amd64-openssl.zip"



# prende server hostname
$serverHostname =  Invoke-Command -ScriptBlock {hostname}


# fornisce ip pubblico zabbix server
$ServerIP = 145.14.161.84


# Crea Zabbix DIR
mkdir c:\zabbix


# Scarica versione dalla variabile a riga 13
Invoke-WebRequest "$version702ssl" -outfile c:\zabbix\zabbix.zip

Add-Type -AssemblyName System.IO.Compression.FileSystem
function Unzip
{
    param([string]$zipfile, [string]$outpath)

    [System.IO.Compression.ZipFile]::ExtractToDirectory($zipfile, $outpath)
}

# Unzip
Unzip "c:\Zabbix\zabbix.zip" "c:\zabbix"      

# sposta files
Move-Item c:\zabbix\bin\zabbix_agentd.exe -Destination c:\zabbix

# sposta conf
Move-Item c:\zabbix\conf\zabbix_agentd.conf -Destination c:\zabbix

# imposta ip pubblico server zabbix in conf
(Get-Content -Path c:\zabbix\zabbix_agentd.conf) | ForEach-Object {$_ -Replace '127.0.0.1', "$ServerIP"} | Set-Content -Path c:\zabbix\zabbix_agentd.conf

# imposta hostname in conf
(Get-Content -Path c:\zabbix\zabbix_agentd.conf) | ForEach-Object {$_ -Replace 'Windows host', "$ServerHostname"} | Set-Content -Path c:\zabbix\zabbix_agentd.conf

# tenta installazione agent
c:\zabbix\zabbix_agentd.exe --config c:\zabbix\zabbix_agentd.conf --install

# tenta start agent
c:\zabbix\zabbix_agentd.exe --start

# crea regola su fw windows
New-NetFirewallRule -DisplayName "Allow Zabbix communication" -Direction Inbound -Program "c:\zabbix\zabbix_agentd.exe" -RemoteAddress LocalSubnet -Action Allow
