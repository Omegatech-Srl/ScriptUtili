#
# SCRIPT PRONTO ALL'USO
#

# Installa Zabbix agent su Windows
# Testato su Windows Server 2012, 2012R2, 2016, 2019
# Versione 2.02
# Creato da Matteo Giustini
# Ultimo update 14/08/2024


# Define the necessary variables
$zabbixMsiUrl = "https://cdn.zabbix.com/zabbix/binaries/stable/7.0/7.0.2/zabbix_agent-7.0.2-windows-amd64-openssl.msi"
$zabbixServerIP = "145.14.161.84"
$installFolder = "C:\Program Files\Zabbix Agent"

# Download the Zabbix Agent MSI
Write-Host "Downloading Zabbix Agent..."
$msiPath = "$env:TEMP\zabbix_agent.msi"
Invoke-WebRequest -Uri $zabbixMsiUrl -OutFile $msiPath

# Install the Zabbix Agent using msiexec
Write-Host "Installing Zabbix Agent..."
Start-Process msiexec.exe -ArgumentList "/i `"$msiPath`" /qn INSTALLFOLDER=`"$installFolder`" SERVER=`"$zabbixServerIP`"" -NoNewWindow -Wait

# Check if installation was successful
if (-Not (Test-Path -Path "$installFolder\zabbix_agentd.conf")) {
    Write-Error "Zabbix Agent installation failed or configuration file not found."
    exit 1
}

# Start the Zabbix Agent service
Write-Host "Starting Zabbix Agent service..."
Start-Service -Name "Zabbix Agent"

# Check if the service started successfully
$serviceStatus = Get-Service -Name "Zabbix Agent"
if ($serviceStatus.Status -eq "Running") {
    Write-Host "Zabbix Agent service started successfully."
} else {
    Write-Error "Failed to start Zabbix Agent service."
}

# Optional: Clean up downloaded MSI
Remove-Item -Path $msiPath -Force

Write-Host "Zabbix Agent installation and configuration completed."
